"use strict";var classCallCheck=function(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")},createClass=function(){function t(t,i){for(var e=0;e<i.length;e++){var s=i[e];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(i,e,s){return e&&t(i.prototype,e),s&&t(i,s),i}}(),Turtle=function(){function t(i){if(classCallCheck(this,t),!(i instanceof HTMLElement))return console.error("Param needs to be an instance of HTMLElement"),!1;this.finishLoadingItems=this.finishLoadingItems.bind(this),this.wrapper=i.cloneNode(!0),this.oldWrapperReference=i,this.items=Array.from(this.wrapper.querySelectorAll("img")),this.totalItems=this.items.length,this.wrapperWidth=i.getBoundingClientRect().width}return createClass(t,[{key:"init",value:function(t,i){var e=this;"function"==typeof i&&(this.userCallback=i),this.config=Object.assign({wrapperPadding:0,itemMargin:4,itemMarginUnit:"px",minWidth:100,maxWidth:400,minHeight:50,maxHeight:400,resize:!1},t),this.reset(),this.config.minWidth>this.config.maxWidth&&(this.config.maxWidth=this.config.minWidth),this.wrapperWidthForUse=this.wrapperWidth-2*this.config.wrapperPadding,this.maxItems=Math.floor(this.wrapperWidth/this.config.minWidth),this.minItems=Math.floor(this.wrapperWidth/this.config.maxWidth),this.styleTag&&this.styleTag.remove();var s=document.createElement("style");s.type="text/css",s.innerHTML=".turtlejs { padding: "+this.config.wrapperPadding+"px; } .turtlejs-item { margin: 0 "+(this.config.itemMargin/2+this.config.itemMarginUnit)+" "+(this.config.itemMargin+this.config.itemMarginUnit)+"; display: inline-block; vertical-align: top; }",document.head.appendChild(s),this.styleTag=s,this.wrapper.classList.add("turtlejs");for(var n=0;n<this.totalItems;n++)this.items[n].classList.add("turtlejs-item"),this.items[n].complete?this.finishLoadingItems():this.items[n].addEventListener("load",this.finishLoadingItems),this.items[n].turtle={ratio:{width:0,height:0}};this.itemsMap=new WeakMap,this.items.forEach(function(t){e.itemsMap.set(t,t)})}},{key:"finishLoadingItems",value:function(){this.totalLoadedItems+=1,this.totalLoadedItems==this.totalItems-1&&this.initItems()}},{key:"initItems",value:function(){for(var t=this.items,i=0;i<t.length;i++)t[i].turtle.ratio.height=1,t[i].turtle.ratio.width=t[i].naturalWidth/t[i].naturalHeight;this.unprocessedItems=JSON.parse(JSON.stringify(this.items));var e=0;this.unprocessedItems.map(function(t){return t.key=e++}),this.wrapperWidthForUse>=2*this.config.minWidth&&this.fix()}},{key:"fix",value:function(){var t=this,i=void 0;if(1===this.unprocessedItems.length)this.unprocessedItems.shift();else{for(var e=Math.min(this.maxItems,this.unprocessedItems.length),s=function(i){for(var e=i,s=0,n=0;n<e;n++)s+=t.items[t.unprocessedItems[n].key].turtle.ratio.width;for(var r=0;r<e;r++){var a=t.items[t.unprocessedItems[0].key].turtle.ratio.width/s;if("px"==t.config.itemMarginUnit?t.items[t.unprocessedItems[0].key].style.width="calc("+100*a+"% - "+(t.config.itemMargin*e*a+t.config.itemMarginUnit)+")":"%"==t.config.itemMarginUnit&&(t.items[t.unprocessedItems[0].key].style.width="calc("+100*a+"% - (100% * "+t.config.itemMargin*e*(a/100)+"))"),t.unprocessedItems.splice(0,1),0===t.unprocessedItems.length)return!1}};e>=this.minItems&&function(n){for(var r=n,a=!0,h=0;h<r;h++){var o=t.items[t.unprocessedItems[h].key].turtle.ratio;(i=(t.wrapperWidthForUse-t.config.itemMargin*r)/r*o.height)>t.config.minHeight&&i<t.config.maxHeight||(a=!1)}return!a&&e>Math.min(t.minItems,2)?(e-=1,!0):(s(e),!1)}(e););if(e<this.config.minItems)return console.warn("An error occurred"),!1}this.unprocessedItems.length>0?this.fix():(this.wrapper.innerHTML="",this.items.forEach(function(t){this.wrapper.appendChild(t)},this),this.wrapper.innerHTML=this.wrapper.innerHTML.replace(/>\s+</g,"><"),this.oldWrapperReference.innerHTML=this.wrapper.innerHTML,"function"==typeof this.userCallback&&this.userCallback())}},{key:"reset",value:function(){this.totalLoadedItems=0,this.unprocessedItems=[]}}]),t}();
